<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commercial Guardian AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        body { background-color: #0f172a; color: white; font-family: sans-serif; overflow: hidden; }
        .node rect { fill: #1e293b; stroke: #334155; stroke-width: 2px; rx: 8; ry: 8; }
        .node text { fill: #cbd5e1; font-size: 12px; text-anchor: middle; dominant-baseline: middle; }
        .link { fill: none; stroke: #475569; stroke-width: 2px; }
        .node.active rect { stroke: #3b82f6; stroke-width: 3px; filter: drop-shadow(0 0 8px #3b82f6); }
        .node.success rect { stroke: #22c55e; }
        .node.error rect { stroke: #ef4444; }
        .log-entry { font-family: monospace; font-size: 11px; padding: 4px; border-bottom: 1px solid #334155; }
    </style>
</head>
<body>
    <div class="flex h-screen w-full">
        <div class="w-2/3 h-full bg-slate-900 relative border-r border-slate-700">
            <div class="absolute top-5 left-5 z-10">
                <h1 class="text-xl font-bold text-blue-400">Commercial Guardian AI</h1>
                <p class="text-xs text-slate-400">SECURE LOCAL AUDIT</p>
            </div>
            <svg id="viz" width="100%" height="100%"></svg>
            <div class="absolute bottom-10 left-1/2 -translate-x-1/2">
                <!-- Button disabled initially -->
                <button id="run-btn" disabled class="bg-blue-600 text-white px-8 py-2 rounded-full font-bold shadow-lg transition opacity-50 cursor-not-allowed">
                    Connecting...
                </button>
            </div>
        </div>
        <div class="w-1/3 h-full bg-slate-950 flex flex-col">
            <div class="p-4 border-b border-slate-800">
                <h2 class="text-xs font-bold text-slate-500 uppercase">Active Invoice</h2>
                <div id="invoice-box" class="mt-2 p-3 bg-slate-900 rounded border border-slate-800 hidden">
                    <div class="flex justify-between text-sm"><span class="text-slate-400">ID:</span> <span id="inv-id" class="text-yellow-400 font-mono"></span></div>
                    <div class="flex justify-between text-sm"><span class="text-slate-400">Vendor:</span> <span id="inv-vendor" class="text-white"></span></div>
                    <div class="flex justify-between text-sm"><span class="text-slate-400">Total:</span> <span id="inv-amount" class="text-green-400 font-bold"></span></div>
                </div>
                <div id="invoice-wait" class="mt-2 text-sm text-slate-600 italic">Waiting for data...</div>
            </div>
            <div id="logs" class="flex-1 overflow-y-auto p-4 space-y-1"></div>
        </div>
    </div>

    <script>
        // 1. Graph Setup
        const nodes = [
            { id: "1", label: "Ingest Data", x: 300, y: 100 },
            { id: "2", label: "RAG Retrieval", x: 300, y: 200 },
            { id: "3", label: "AI Analysis", x: 300, y: 300 },
            { id: "4", label: "Approve", x: 150, y: 450 },
            { id: "5", label: "Dispute", x: 450, y: 450 },
            { id: "6", label: "Report", x: 300, y: 550 }
        ];
        const links = [
            { source: "1", target: "2" }, { source: "2", target: "3" },
            { source: "3", target: "4" }, { source: "3", target: "5" },
            { source: "4", target: "6" }, { source: "5", target: "6" }
        ];

        const svg = d3.select("#viz");
        svg.append("defs").append("marker")
            .attr("id", "arrow").attr("viewBox", "0 -5 10 10").attr("refX", 95).attr("refY", 0)
            .attr("markerWidth", 6).attr("markerHeight", 6).attr("orient", "auto")
            .append("path").attr("d", "M0,-5L10,0L0,5").attr("fill", "#475569");

        const linkElements = svg.append("g").selectAll("line").data(links).enter().append("line")
            .attr("class", "link").attr("marker-end", "url(#arrow)")
            .attr("x1", d => getNode(d.source).x).attr("y1", d => getNode(d.source).y)
            .attr("x2", d => getNode(d.target).x).attr("y2", d => getNode(d.target).y);

        const nodeElements = svg.append("g").selectAll("g").data(nodes).enter().append("g")
            .attr("class", "node").attr("id", d => "n"+d.id)
            .attr("transform", d => `translate(${d.x},${d.y})`);

        nodeElements.append("rect").attr("x", -90).attr("y", -20).attr("width", 180).attr("height", 40);
        nodeElements.append("text").text(d => d.label);

        function getNode(id) { return nodes.find(n => n.id === id); }
        function highlight(id) {
            d3.selectAll(".node").classed("active", false);
            d3.select("#n"+id).classed("active", true);
            nodes.forEach(n => { if(parseInt(n.id) < parseInt(id)) d3.select("#n"+n.id).classed("success", true); });
        }
        function log(msg, color="text-slate-300") {
            const div = document.createElement("div");
            div.className = `log-entry ${color}`;
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            document.getElementById("logs").prepend(div);
        }

        // 2. WebSocket Connection
        const wsUrl = `ws://${window.location.hostname}:8000/ws`;
        let ws;
        const btn = document.getElementById("run-btn");

        function connect() {
            log("Connecting to Brain...", "text-blue-400");
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                log("System Connected.", "text-green-400");
                // Enable button only when connected
                btn.disabled = false;
                btn.innerText = "â–¶ Run Live Audit";
                btn.classList.remove("opacity-50", "cursor-not-allowed");
                btn.classList.add("hover:bg-blue-500");
            };
            
            ws.onmessage = (evt) => {
                const data = JSON.parse(evt.data);
                if(data.log) log(data.log, data.type === 'error' ? 'text-red-400' : 'text-blue-300');
                if(data.active_node) highlight(data.active_node);
                if(data.invoice) {
                    document.getElementById("invoice-wait").classList.add("hidden");
                    document.getElementById("invoice-box").classList.remove("hidden");
                    document.getElementById("inv-id").innerText = data.invoice.invoice_id;
                    document.getElementById("inv-vendor").innerText = data.invoice.vendor;
                    document.getElementById("inv-amount").innerText = "$" + data.invoice.total_amount;
                }
            };

            ws.onclose = () => {
                log("Disconnected. Retrying...", "text-red-500");
                // Disable button on disconnect
                btn.disabled = true;
                btn.innerText = "Reconnecting...";
                btn.classList.add("opacity-50", "cursor-not-allowed");
                setTimeout(connect, 3000);
            };
        }

        connect();

        btn.onclick = () => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                document.getElementById("logs").innerHTML = "";
                d3.selectAll(".node").attr("class", "node");
                log("Starting Audit...", "text-yellow-400");
                ws.send("run");
            } else {
                log("Not connected yet. Please wait.", "text-red-500");
            }
        };
    </script>
</body>
</html>